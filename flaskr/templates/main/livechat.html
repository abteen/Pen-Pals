<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="referrer" content="no-referrer"/>
  <title>Pen Pals</title>
  <!-- Compiled and minified CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdn.rawgit.com/AlexVentura/4d0c725c34941fa42361350dcb43731f/raw/e7eba7b9603237a8e4623f305abc46e60908d146/sponsor.matchxperience.css">
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/animate.css') }}">
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">

  <!-- Compiled and minified JavaScript -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.rawgit.com/Dogfalo/materialize/v1-dev/extras/noUiSlider/nouislider.min.js"></script>
</head>
<body>
<div class="row neutral-color">
    <div class="col s2 fixed" id="conversation-window">
		<form id="search_form" method="post">
			<span class="flow-text"><i class="small material-icons" id="search-icon">search</i>Search</span>
			<br>
			<h3 class="flow-text" id="search-text">By favorite book genres:</h3>
			<div class="chips-autocomplete-genre text-darken-2"></div>
			<h3 class="flow-text" id="search-text">By favorite book titles:</h3>
			<div class="chips-autocomplete-book text-darken-2" name="title"></div>

			<div id="slider"></div>

			<button id="search-button" class="btn waves-effect waves-light secondary-color" type="button" name="button" onclick="search();">Search</button>
			<br>
			<button id="search-edit-button" class="btn waves-effect waves-light" type="button" name="button" onclick="edit_bio();">Edit Bio</button>


		</form>
	</div>
	<div class="col s2" id="conversation-holder">
	</div>
    <div class="col s10 neutral-color" >
		<h1 id="recipient">George</h1>
		<div id="bubble-container"> 
			
		</div>
		
		
	</div>
	<div id="message-field-container" class="fixed">
			<div class="row">
				<form id="message_form" method="post">
					<div class="input-field col m12">
						<textarea id="message" class="materialize-textarea" name="mesg" onkeypress="return noenter()"></textarea>
						<label for="message"> </label>
					</div>
				</form>
				<button id="send-button" class="btn waves-effect waves-light secondary-color" type="button" name="button" onclick="submit();"><i class="material-icons send-icon">send</i></button>
			</div>
		</div>
</div>
</body>
<div class="row temp-nav">
	<a href="{{ url_for('auth.logout') }}">log out</a>
    <a href="{{ url_for('main.bio') }}">View Bio</a>
    <a href="{{ url_for('main.create_bio') }}">Create Bio</a>
    <a href="{{url_for('main.home')}}">Home</a>
    <a href="{{ url_for('main.chatdb') }}">Chat database</a>
</div>
<!-- Footer Section -->
	<footer class="page-footer white">
		<div class="footer-copyright">
			<p id="copyright">copyrighted mother effers</p>
		</div>
	</footer>


<script type="text/javascript">
console.log("im being called");
refreshChat();
function submit(){
	var messages = $();
	form = document.forms['message_form'];
	msg = form.elements['mesg'].value;
	if (msg.trim() === ""){
		return;
	}
	console.log(msg);
	console.log("im being called pt 3");
	$.ajax({
		url: '/main/livechat',
		data:  {
			'the_message' : msg,
			'otherEmail' : localStorage.getItem("storedEmail"),
			'flag' : 1
		},
		type: 'POST',
		success: function(response) {
			var obj = JSON.parse(response);
			row = {};
			for (messageIndex in obj) {
				row = obj[messageIndex];
			}
			messages = messages.add(createMessage(row, localStorage.getItem("storedEmail")));
			$('#bubble-container').append(messages);
			console.log("no err two");
		},
		error: function(error) {
			console.log("err two");
		}
	});
	console.log("im being called part 4");
	document.getElementById('message').value = '';
}

function refreshChat(){
	var messages = $();
	$("#bubble-container").html("");
	$('#recipient').css("display", "block");
	$('#recipient').html(localStorage.getItem("storedEmail"));
	$.ajax({
		   url: '/main/livechat',
		   data:  {
				'otherEmail' : localStorage.getItem("storedEmail"),
				'flag' : 0
			},
		   type: 'POST',
		   success: function(response) {
				var obj = JSON.parse(response);	
				for (messageIndex in obj) {
					row = obj[messageIndex];
					messages = messages.add(createMessage(row, localStorage.getItem("storedEmail")));
				}
				$('#bubble-container').append(messages);
				console.log("no err two");
			},
			error: function(error) {
			   console.log("err");
		   }
	   });
	console.log("im being called part 2");
}

function createMessage(messageData, to) {
	if(messageData.sender == to){
		var bubble = [
		'<div class="row bubble-margin">',
		'<div class="speech-bubble-left">',
		'<h1 class="bubble-text">',
		messageData.message,
		'</h1>',
		'</div>',
		'</div>'
		];
	}
	else{
		var bubble = [
			'<div class="row bubble-margin">',
			'<div class="speech-bubble-right">',
			'<h1 class="bubble-text">',
			messageData.message,
			'</h1>',
			'</div>',
			'</div>'
		];
	}
	return $(bubble.join(''));
}
</script>

<script>
$(document).ready(function(){
	$('#message_form').keypress(function(e){
		if(e.keyCode==13){
			$('#send-button').click();
		}
	});
});

</script>
<script type="text/javascript">
function noenter() {
	return !(window.event && window.event.keyCode == 13); 
}
</script>










</html>
