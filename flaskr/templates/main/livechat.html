<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="referrer" content="no-referrer"/>
  <title>Pen Pals</title>
  <!-- Compiled and minified CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdn.rawgit.com/AlexVentura/4d0c725c34941fa42361350dcb43731f/raw/e7eba7b9603237a8e4623f305abc46e60908d146/sponsor.matchxperience.css">
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/animate.css') }}">
  <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">

  <!-- Compiled and minified JavaScript -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.rawgit.com/Dogfalo/materialize/v1-dev/extras/noUiSlider/nouislider.min.js"></script>
</head>
<body>
<div class="row neutral-color">
  <div class="col s3 fixed" id="convo-container">

  </div>
	   <div class="col s3" id="conversation-holder">
	   </div>
    <div class="col s8 neutral-color" >
		    <h3 id="recipient"></h3>
		    <div id="bubble-container">
		    </div>
    </div>

	<div id="message-field-container" class="fixed">
    <h1 id="recipient"></h1>
			<div class="row">
				<form id="message_form" method="post">
					<div class="input-field col m12">
						<textarea id="message" class="materialize-textarea" name="mesg" onkeypress="return noenter()"></textarea>
						<label for="message"> </label>
					</div>
				</form>
				<button id="send-button" class="btn waves-effect waves-light secondary-color" type="button" name="button" onclick="submit();"><i class="material-icons send-icon">send</i></button>
			</div>
		</div>
</div>
</body>
<textarea id="useremail" class="hidden">{{user.email}}</textarea>
<div class="row temp-nav">
	<a href="{{ url_for('auth.logout') }}">log out</a>
    <a href="{{ url_for('main.bio') }}">View Bio</a>
    <a href="{{ url_for('main.create_bio') }}">Create Bio</a>
    <a href="{{url_for('main.home')}}">Home</a>
    <a href="{{ url_for('main.chatdb') }}">Chat database</a>
</div>
<!-- Footer Section -->
	<footer class="page-footer white">
		<div class="footer-copyright">
			<p id="copyright">copyrighted mother effers</p>
		</div>
	</footer>


<script type="text/javascript">
console.log("im being called");
refreshChat();
refreshConvos();
function submit(){
	var messages = $();
	form = document.forms['message_form'];
	msg = form.elements['mesg'].value;
	if (msg.trim() === ""){
		return;
	}
	console.log(msg);
	console.log("im being called pt 3");
	$.ajax({
		url: '/main/livechat',
		data:  {
			'the_message' : msg,
			'otherEmail' : localStorage.getItem("storedEmail"),
			'flag' : 1
		},
		type: 'POST',
		success: function(response) {
			var splitter = response.split("\n");
			var obj1 = JSON.parse(splitter[0]);
			var obj2 = JSON.parse(splitter[1]);
			row = {};
			for (messageIndex in obj2) {
				row = obj2[messageIndex];
			}
			messages = messages.add(createMessage(row, localStorage.getItem("storedEmail")));
			$('#bubble-container').append(messages);
			console.log("no err two");
		},
		error: function(error) {
			console.log("err two");
		}
	});
	console.log("im being called part 4");
	document.getElementById('message').value = '';
}

function refreshChat(){
	var messages = $();
	$("#bubble-container").html("");
	$('#recipient').css("display", "block");
	$('#recipient').html(localStorage.getItem("storedEmail"));
	$.ajax({
		url: '/main/livechat',
		data:  {
			'otherEmail' : localStorage.getItem("storedEmail"),
			'flag' : 0
		},
		type: 'POST',
		success: function(response) {
			console.log(response);
			var splitter = response.split("\n");
			var obj2 = JSON.parse(splitter[1]);
			for (messageIndex in obj2) {
				row = obj2[messageIndex];
				messages = messages.add(createMessage(row, localStorage.getItem("storedEmail")));
			}
			$('#bubble-container').append(messages);
		},
		error: function(error) {
			console.log("err");
		}
	});
}

function refreshConvos(){
	var conversations = $();
	$("#convo-container").html("");
	$.ajax({
		url: '/main/livechat',
		data:  {
			'otherEmail' : localStorage.getItem("storedEmail"),
			'flag' : 0
		},
		type: 'POST',
		success: function(response) {
			console.log(response);
			var splitter = response.split("\n");
			var obj1 = JSON.parse(splitter[0]);
			var obj3 = JSON.parse(splitter[2]);
			console.log(obj3);
			for (convoIndex in obj1) {
					row2 = obj1[convoIndex];
					conversations = conversations.add(createConvo(row2, localStorage.getItem("storedEmail")));
			}
			$('#convo-container').append(conversations);
			console.log("no err two");
		},
		error: function(error) {
			console.log("err");
		}
	});
}

function createMessage(messageData, to) {
	if(messageData.sender == to){
		var bubble = [
		'<div class="row bubble-margin">',
		'<div class="speech-bubble-left">',
		'<h1 class="bubble-text">',
		messageData.message,
		'</h1>',
		'</div>',
		'</div>'
		];
	}
	else{
	var bubble = [
		'<div class="row bubble-margin">',
		'<div class="speech-bubble-right">',
		'<h1 class="bubble-text">',
		messageData.message,
		'</h1>',
		'</div>',
		'</div>'
		];
	}
	return $(bubble.join(''));
}

function createConvo(convoData, to) {
    recipient = convoData.identifier;
    recipientArr = [];
    recipientArr = recipient.split(":");
    you = document.getElementById('useremail').value;
    if(recipientArr[0] == you){
      recipient = recipientArr[1];
    }
    else{
      recipient = recipientArr[0];
    }
    var slate = [
		'<div id="slate" class="slate row" name="',
		recipient,
		'">',
		'<h5>',
		recipient,
		'</h5>',
		'</div>',
		'<hr>'
	];
	return $(slate.join(''));
}

$(document).on("click","#slate", function () {
	var morphEmail = $(this).attr('name'); // or var clickedBtnID = this.id
	localStorage.setItem("storedEmail",morphEmail);
  refreshChat();
//	window.location.href='/main/livechat';
});

$(document).ready(function(){
	$('#message_form').keypress(function(e){
		if(e.keyCode==13){
			$('#send-button').click();
		}
	});
});

function noenter() {
	return !(window.event && window.event.keyCode == 13);
}
</script>
</html>
